<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ScanAR ‚Äì overlay in camera view</title>
<script src="https://unpkg.com/html5-qrcode" defer></script>
<style>
  :root{--accent:#60a5fa;--text:#e5e7eb;--muted:#9ca3af;--bg:#0f172a}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;background:var(--bg);color:var(--text);min-height:100svh;display:grid;place-items:center;padding:12px}
  .wrap{width:min(820px,100%);display:grid;gap:10px}
  h1{margin:0;font-size:clamp(1.1rem,2vw + .6rem,1.6rem)}
  .status{font-size:.95rem;color:var(--muted)}
  /* Scanner region is relative so we can absolutely-position the AR overlay on top. */
  #scannerWrap{position:relative;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.12)}
  #scanner{width:100%;background:#000;min-height:320px}
  /* AR overlay that sits above the camera feed */
  #arLayer{position:absolute;inset:0;pointer-events:none} /* default no interaction */
  .hud{position:absolute;inset:12px auto auto 12px;display:flex;gap:8px;pointer-events:auto} /* clickable */
  .hud button{appearance:none;border:1px solid rgba(255,255,255,.3);background:rgba(0,0,0,.45);backdrop-filter:blur(6px);
    color:#fff;padding:.45rem .7rem;border-radius:.65rem;font-weight:600;cursor:pointer}
  .hud button:disabled{opacity:.5;cursor:not-allowed}
  .hint{position:absolute;right:12px;bottom:12px;background:rgba(0,0,0,.45);backdrop-filter:blur(6px);padding:.35rem .55rem;border-radius:.5rem;font-size:.85rem}
  /* Draggable media nodes */
  .draggable{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    box-shadow:0 10px 30px rgba(0,0,0,.5);border-radius:10px;border:1px solid rgba(255,255,255,.25);pointer-events:auto}
  #arImage{max-width:55%;max-height:55%;display:none}
  #arVideo{max-width:65%;max-height:65%;display:none;background:#000}
  /* Grab handle */
  .handle{position:absolute;top:-34px;left:0;display:flex;gap:8px}
  .handle button{appearance:none;border:1px solid rgba(255,255,255,.3);background:rgba(0,0,0,.45);
    color:#fff;padding:.25rem .5rem;border-radius:.5rem;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <h1>Scan to unlock AR overlay</h1>
  <div class="status" id="scanStatus">Waiting for camera‚Ä¶</div>

  <div id="scannerWrap">
    <div id="scanner"></div>

    <!-- AR overlay (hidden until success) -->
    <div id="arLayer" style="display:none;">
      <!-- Floating controls inside camera view -->
      <div class="hud">
        <button id="btnShowImage" disabled>üñºÔ∏è Image</button>
        <button id="btnShowVideo" disabled>‚ñ∂Ô∏è Video</button>
        <button id="btnHide" disabled>‚úï Hide</button>
      </div>
      <div class="hint">Drag the media around</div>

      <!-- Draggable media nodes -->
      <img id="arImage" class="draggable" src="image.png" alt="AR image" />
      <video id="arVideo" class="draggable" playsinline muted loop preload="metadata">
        <source src="video.mp4" type="video/mp4" />
      </video>
    </div>
  </div>
</div>

<script>
  // Accept only this payload; set to "" to accept any
  const EXPECTED_CODE = "SCAN-OK";

  // How long after the last valid frame the overlay should remain visible
  const HIDE_AFTER_MS = 700;

  const scanStatus = document.getElementById('scanStatus');
  const scannerDiv = document.getElementById('scanner');
  const arLayer   = document.getElementById('arLayer');
  const arImage   = document.getElementById('arImage');
  const arVideo   = document.getElementById('arVideo');
  const btnImg    = document.getElementById('btnShowImage');
  const btnVid    = document.getElementById('btnShowVideo');
  const btnHide   = document.getElementById('btnHide');

  // ---- draggable (unchanged) ----
  function makeDraggable(el) {
    let dragging=false,startX=0,startY=0,origX=0,origY=0;
    function down(e){
      dragging=true;
      const p=(e.touches?e.touches[0]:e);
      startX=p.clientX; startY=p.clientY;
      const r=el.getBoundingClientRect(); origX=r.left+r.width/2; origY=r.top+r.height/2;
      document.addEventListener('mousemove', move);
      document.addEventListener('touchmove', move, {passive:false});
      document.addEventListener('mouseup', up);
      document.addEventListener('touchend', up);
    }
    function move(e){
      if(!dragging) return;
      if(e.cancelable) e.preventDefault();
      const p=(e.touches?e.touches[0]:e);
      const dx=p.clientX-startX, dy=p.clientY-startY;
      const wrap=document.getElementById('scannerWrap').getBoundingClientRect();
      let cx=origX+dx, cy=origY+dy;
      const leftPct=((cx-wrap.left)/wrap.width)*100;
      const topPct =((cy-wrap.top )/wrap.height)*100;
      el.style.left=leftPct+"%"; el.style.top=topPct+"%"; el.style.transform="translate(-50%,-50%)";
    }
    function up(){
      dragging=false;
      document.removeEventListener('mousemove', move);
      document.removeEventListener('touchmove', move);
      document.removeEventListener('mouseup', up);
      document.removeEventListener('touchend', up);
    }
    el.addEventListener('mousedown', down);
    el.addEventListener('touchstart', down, {passive:true});
  }
  makeDraggable(arImage);
  makeDraggable(arVideo);

  // ---- media controls (unchanged) ----
  function showImage(){ arVideo.pause(); arVideo.style.display="none"; arImage.style.display="block"; }
  function showVideo(){ arImage.style.display="none"; arVideo.style.display="block"; arVideo.play().catch(()=>{}); }
  function hideAll(){   arImage.style.display="none"; arVideo.pause(); arVideo.style.display="none"; }
  btnImg.addEventListener('click', showImage);
  btnVid.addEventListener('click', showVideo);
  btnHide.addEventListener('click', hideAll);

  // ---- visibility logic tied to continuous detection ----
  let lastSeenOk = 0;
  let overlayVisible = false;

  function showOverlay() {
    if (overlayVisible) return;
    overlayVisible = true;
    arLayer.style.display = "block";
    btnImg.disabled = btnVid.disabled = btnHide.disabled = false;
    scanStatus.textContent = "‚úÖ QR in view ‚Äî overlay unlocked.";
  }
  function hideOverlay() {
    if (!overlayVisible) return;
    overlayVisible = false;
    arLayer.style.display = "none";
    btnImg.disabled = btnVid.disabled = btnHide.disabled = true;
    hideAll();
    scanStatus.innerHTML = EXPECTED_CODE
      ? `‚ùå Wrong/lost code. Looking for: <code>${EXPECTED_CODE}</code>`
      : "‚ùå QR lost.";
  }

  // Heartbeat that hides the overlay if the code hasn't been seen recently
  setInterval(() => {
    if (overlayVisible && (Date.now() - lastSeenOk) > HIDE_AFTER_MS) {
      hideOverlay();
    }
  }, Math.max(120, HIDE_AFTER_MS / 3));

  // ---- scanner setup ----
  window.addEventListener('load', async () => {
    if (!window.Html5Qrcode) { scanStatus.textContent="Failed to load scanner library."; return; }

    const html5QrCode = new Html5Qrcode("scanner");
    const config = { fps: 15, qrbox: (w,h)=>({ width: Math.min(w,h)*0.72, height: Math.min(w,h)*0.72 }) };

    function onScanSuccess(decodedText) {
      const ok = !EXPECTED_CODE || decodedText.trim() === EXPECTED_CODE;
      if (ok) {
        lastSeenOk = Date.now();
        showOverlay();               // keep visible while we keep seeing the code
      } else {
        // Don't immediately hide to avoid flicker; the heartbeat will hide if it keeps failing.
      }
    }
    function onScanError(_) { /* ignore noisy frames */ }

    try {
      scanStatus.textContent="Requesting camera‚Ä¶";
      const cams = await Html5Qrcode.getCameras();
      if (!cams || !cams.length) throw new Error("No camera found");
      scanStatus.textContent="Point your camera at the QR code.";
      await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanError);
    } catch(e) {
      scanStatus.textContent="Camera unavailable: " + (e.message || e);
    }
  });
</script>

</body>
</html>
