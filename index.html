<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ScanAR ‚Äì overlay in camera view</title>
<script src="https://unpkg.com/html5-qrcode" defer></script>
<style>
  :root{--accent:#60a5fa;--text:#e5e7eb;--muted:#9ca3af;--bg:#0f172a}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;background:var(--bg);color:var(--text);min-height:100svh;display:grid;place-items:center;padding:12px}
  .wrap{width:min(820px,100%);display:grid;gap:10px}
  h1{margin:0;font-size:clamp(1.1rem,2vw + .6rem,1.6rem)}
  .status{font-size:.95rem;color:var(--muted)}
  /* Scanner region is relative so we can absolutely-position the AR overlay on top. */
  #scannerWrap{position:relative;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.12)}
  #scanner{width:100%;background:#000;min-height:320px}
  /* AR overlay that sits above the camera feed */
  #arLayer{position:absolute;inset:0;pointer-events:none} /* default no interaction */
  .hud{position:absolute;inset:12px auto auto 12px;display:flex;gap:8px;pointer-events:auto} /* clickable */
  .hud button{appearance:none;border:1px solid rgba(255,255,255,.3);background:rgba(0,0,0,.45);backdrop-filter:blur(6px);
    color:#fff;padding:.45rem .7rem;border-radius:.65rem;font-weight:600;cursor:pointer}
  .hud button:disabled{opacity:.5;cursor:not-allowed}
  .hint{position:absolute;right:12px;bottom:12px;background:rgba(0,0,0,.45);backdrop-filter:blur(6px);padding:.35rem .55rem;border-radius:.5rem;font-size:.85rem}
  /* Draggable media nodes */
  .draggable{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    box-shadow:0 10px 30px rgba(0,0,0,.5);border-radius:10px;border:1px solid rgba(255,255,255,.25);pointer-events:auto}
  #arImage{max-width:55%;max-height:55%;display:none}
  #arVideo{max-width:65%;max-height:65%;display:none;background:#000}
  /* Grab handle */
  .handle{position:absolute;top:-34px;left:0;display:flex;gap:8px}
  .handle button{appearance:none;border:1px solid rgba(255,255,255,.3);background:rgba(0,0,0,.45);
    color:#fff;padding:.25rem .5rem;border-radius:.5rem;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <h1>Scan to unlock AR overlay</h1>
  <div class="status" id="scanStatus">Waiting for camera‚Ä¶</div>

  <div id="scannerWrap">
    <div id="scanner"></div>

    <!-- AR overlay (hidden until success) -->
    <div id="arLayer" style="display:none;">
      <!-- Floating controls inside camera view -->
      <div class="hud">
        <button id="btnShowImage" disabled>üñºÔ∏è Image</button>
        <button id="btnShowVideo" disabled>‚ñ∂Ô∏è Video</button>
        <button id="btnHide" disabled>‚úï Hide</button>
      </div>
      <div class="hint">Drag the media around</div>

      <!-- Draggable media nodes -->
      <img id="arImage" class="draggable" src="image.png" alt="AR image" />
      <video id="arVideo" class="draggable" playsinline muted loop preload="metadata">
        <source src="video.mp4" type="video/mp4" />
      </video>
    </div>
  </div>
</div>

<script>
  // ====== CONFIGURE THIS ======
  const EXPECTED_CODE = "SCAN-OK"; // change to the QR payload you expect; use "" to accept any
  // ============================

  const scanStatus = document.getElementById('scanStatus');
  const scannerDiv = document.getElementById('scanner');
  const arLayer = document.getElementById('arLayer');
  const arImage = document.getElementById('arImage');
  const arVideo = document.getElementById('arVideo');
  const btnImg = document.getElementById('btnShowImage');
  const btnVid = document.getElementById('btnShowVideo');
  const btnHide = document.getElementById('btnHide');

  // Simple draggable behavior for AR nodes
  function makeDraggable(el) {
    let dragging = false, startX=0, startY=0, origX=0, origY=0;

    function down(e){
      dragging = true;
      const p = (e.touches ? e.touches[0] : e);
      startX = p.clientX; startY = p.clientY;
      const r = el.getBoundingClientRect();
      origX = r.left + r.width/2; origY = r.top + r.height/2;
      document.addEventListener('mousemove', move);
      document.addEventListener('touchmove', move, {passive:false});
      document.addEventListener('mouseup', up);
      document.addEventListener('touchend', up);
    }
    function move(e){
      if(!dragging) return;
      if(e.cancelable) e.preventDefault();
      const p = (e.touches ? e.touches[0] : e);
      const dx = p.clientX - startX;
      const dy = p.clientY - startY;
      const wrap = document.getElementById('scannerWrap').getBoundingClientRect();
      // compute new center
      let cx = origX + dx, cy = origY + dy;
      // convert to percentages to keep relative on resize
      const leftPct = ((cx - wrap.left)/wrap.width)*100;
      const topPct  = ((cy - wrap.top)/wrap.height)*100;
      el.style.left = leftPct + "%";
      el.style.top  = topPct + "%";
      el.style.transform = "translate(-50%,-50%)";
    }
    function up(){
      dragging = false;
      document.removeEventListener('mousemove', move);
      document.removeEventListener('touchmove', move);
      document.removeEventListener('mouseup', up);
      document.removeEventListener('touchend', up);
    }
    el.addEventListener('mousedown', down);
    el.addEventListener('touchstart', down, {passive:true});
  }
  makeDraggable(arImage);
  makeDraggable(arVideo);

  // Buttons logic
  function showImage() {
    arVideo.pause(); arVideo.style.display = "none";
    arImage.style.display = "block";
  }
  function showVideo() {
    arImage.style.display = "none";
    arVideo.style.display = "block";
    // Autoplay policies usually allow autoplay if muted (we set muted)
    arVideo.play().catch(()=>{});
  }
  function hideAll() {
    arImage.style.display = "none";
    arVideo.pause(); arVideo.style.display = "none";
  }
  btnImg.addEventListener('click', showImage);
  btnVid.addEventListener('click', showVideo);
  btnHide.addEventListener('click', hideAll);

  // Scanner
  window.addEventListener('load', async () => {
    if (!window.Html5Qrcode) {
      scanStatus.textContent = "Failed to load scanner library."; return;
    }
    const html5QrCode = new Html5Qrcode("scanner");
    const config = { fps: 10, qrbox: (viewW, viewH) => {
      const size = Math.min(viewW, viewH) * 0.7; // responsive square
      return { width: size, height: size };
    }};

    function onScanSuccess(decodedText) {
      const ok = !EXPECTED_CODE || decodedText.trim() === EXPECTED_CODE;
      if (!ok) {
        scanStatus.innerHTML = `‚ùå Wrong code. Looking for: <code>${EXPECTED_CODE}</code>`;
        return;
      }
      // Unlock: keep camera running but show overlay controls on top
      scanStatus.textContent = "‚úÖ Scan successful ‚Äî overlay unlocked.";
      arLayer.style.display = "block";
      btnImg.disabled = btnVid.disabled = btnHide.disabled = false;

      // OPTIONAL: if you want to stop scanning after success, uncomment:
      // html5QrCode.stop();
    }

    function onScanError(_) { /* ignore noisy frames */ }

    try {
      scanStatus.textContent = "Requesting camera‚Ä¶";
      const cams = await Html5Qrcode.getCameras();
      if (!cams || !cams.length) throw new Error("No camera found");
      scanStatus.textContent = "Point your camera at the QR code.";
      await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanError);
    } catch (e) {
      scanStatus.textContent = "Camera unavailable: " + (e.message || e);
    }
  });
</script>
</body>
</html>
